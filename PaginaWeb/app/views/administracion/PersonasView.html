{% extends "base.html" %}
{% block title %} Gestion de Usuarios {% endblock %}
{% block nav %}
{% include 'partials/nav.html' with {datos:datos} only %}
{% endblock %}
{% block main %}
{% block header %}
{% include 'partials/header.html' with {datos:datos} only %}
{% endblock %}
<div>
    <h2 class="titulo-tabla">Personas Registradas </h2>

    <!-- BOTON NEW PERSONA -->
    {% if "45" in datos.permisos %}
    <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#modalNew"><i
            class="fal fa-plus"></i> Crear Nuevo</button>
    {% endif %}

    <!-- TABLA PERSONAS -->
    <table id="miTabla" class="table table-bordered table-sm table-responsive-lg table-striped table-hover">
        <thead class="headtable">
            <tr>
                <th>DNI </th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Direccion</th>
                <th>Email</th>
                <th>Fecha de Nacimiento</th>
                <th>Estado</th>
                <th>Accion</th>
            </tr>
        </thead>
        <tbody>
            {% for persona in datos.todasPersonas %}
            {% if persona.dni != '0' %}
            <tr>
                <td>{{ persona.dni }}</td>
                <td>{{ persona.nombre }}</td>
                <td>{{ persona.apellido }}</td>
                <td>{{ persona.direccion }}</td>
                <td>{{ persona.email }}</td>
                <td>{{ persona.fecha_nacimiento|date("d/m/Y") }}</td>
                <td>{{ persona.estado }}</td>
                <td>
                    {% set deshabilitado = "disabled" %}
                    {% set notAllowed = " notAllowed" %}
                    {% if persona.usado == false %}
                    {% set deshabilitado = "" %}
                    {% set notAllowed = "" %}
                    {% endif %}
                    <div class="btn-group float-none" role="group">
                        {% if "47" in datos.permisos %}
                        <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                            onclick="modificarModal('{{ persona|json_encode }}');" title="Editar Persona"><i
                                class="fal fa-pencil-alt fa-2x fa-fw"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                            onclick="modificarEstadoModal('{{ persona|json_encode }}');" title="Editar Estado"><i
                                class="fal fa-user-clock fa-2x fa-fw"></i>
                        </button>
                        {% endif %}
                        {% if "46" in datos.permisos %}
                        <button type="button" class="btn btn-outline-primary {{ notAllowed }}" {{ deshabilitado }}
                            data-toggle="modal" onclick="eliminarModal('{{ persona|json_encode }}');"
                            title="Eliminar Persona"><i class="fal fa-trash-alt fa-2x fa-fw"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}
            <h2 class='error'>No hay Personas</h2>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- MODALES NEW, UPDATE Y DELETE -->
<!--NEW PERSONA-->
{% if "45" in datos.permisos %}
<div class="modal fade" id="modalNew">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title m-0">Alta de Persona</h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <form action="newPersona" method="post" class="was-validated">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="dni">DNI:</label><span class="asterisco">*</span>
                            <input type="number" name="dni" class="form-control" autofocus required min="10000000">
                            <div class="invalid-feedback">Min:10.000.000</div>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="nombre">Nombre:</label><span class="asterisco">*</span>
                            <input type="text" name="nombre" class="form-control" required>
                            <div class="invalid-feedback">Complete este campo</div>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="apellido">Apellido:</label><span class="asterisco">*</span>
                            <input type="text" name="apellido" class="form-control" required>
                            <div class="invalid-feedback">Complete este campo</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="direccion">Direccion:</label>
                        <input type="text" name="direccion" class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="email">Email:</label>
                            <input type="email" name="email" class="form-control">
                            <div class="invalid-feedback">El formato es incorrecto</div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="fecha_nacimiento">Fecha De Nacimiento:</label><span class="asterisco">*</span>
                            <input type="date" name="fecha_nacimiento" class="form-control" max="{{ datos.minimo18 }}"
                                min="{{ datos.maximo70 }}" required>
                        </div>
                    </div>
                    <input type="text" name="estado" value="Activo" hidden>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!--MODIFICAR PERSONA-->
{% if "47" in datos.permisos %}
<div class="modal fade" id="modalUpdate">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title m-0" id="h3TitleModalUpdate"></h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <form action="updatePersona" method="post" class="was-validated">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="dni">DNI:</label><span class="asterisco">*</span>
                            <input type="number" name="dni" id="updateID" class="form-control" readonly>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="nombre">Nombre:</label><span class="asterisco">*</span>
                            <input type="text" name="nombre" id="nombreAnteriorUpdate" class="form-control" required>
                            <div class="invalid-feedback">Complete este campo</div>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="apellido">Apellido:</label><span class="asterisco">*</span>
                            <input type="text" name="apellido" id="apellidoAnteriorUpdate" class="form-control"
                                required>
                            <div class="invalid-feedback">Complete este campo</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="direccion">Direccion:</label>
                        <input type="text" name="direccion" id="direccionAnteriorUpdate" class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="email">Email:</label>
                            <input type="email" name="email" id="emailAnteriorUpdate" class="form-control">
                            <div class="invalid-feedback">El formato es incorrecto</div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="fecha_nacimiento">Fecha De Nacimiento:</label><span class="asterisco">*</span>
                            <input type="date" name="fecha_nacimiento" id="fechaAnteriorUpdate" class="form-control"
                                max="{{ datos.minimo18 }}" min="{{ datos.maximo70 }}" required>
                        </div>
                    </div>
                    <input type="text" name="estado" value="Activo" hidden>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!--MODIFICAR ESTADO-->
{% if "47" in datos.permisos %}
<div class="modal fade" id="modalEstadoUpdate">
    <div class="modal-dialog modal-xs">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title m-0">Cambiar Estado</h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <form action="updateEstadoPersona" method="post">
                    <input type="text" name="dni" id="updateEstadoID" hidden>
                    <div class="form-group">
                        <label for="estado">Nuevo Estado:</label>
                        <select name="estado" id="estadoUpdate" class="form-control custom-select">
                            {% for estado in datos.estados %}
                            <option value="{{ estado }}">{{ estado }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!--ELIMINAR PERSONA SI NO ESTA USADO-->
{% if "46" in datos.permisos %}
<div class="modal fade" id="modalDelete">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title m-0" id="h3TitleModalDelete"></h3>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <p class="mb-3">¿Está seguro?</p>
                <form action="deletePersona" method="post">
                    <input type="text" name="dni" id="deleteID" hidden>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-modal" data-dismiss="modal">Salir</button>
                        <button type="submit" class="btn btn-danger btn-modal">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- FIN MODALES NEW, UPDATE Y DELETE -->

<script src="/public/js/jsBasicos/jsPersona.js"></script>
<script>
    verificarAlertas('{{ datos.alertas|json_encode|raw }}', 'Persona');
    ordenarTabla('miTabla', '0,1,2,3,4,5,6', [7], 'Personas Registradas');
</script>
{% endblock %}