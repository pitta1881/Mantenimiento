{% extends "base0.html" %}
{% block title %} Gestion de Usuarios {% endblock %}
{% block nav %}
{% include 'partials/nav.html' with {datos:datos} only %}
{% endblock %}
{% block main %}
{% if datos.errorInsert %}
<script>
    alertify.alert(
        "<span class='fa fa-times-circle fa-2x' style='vertical-align:middle;color:#e10000'></span><span style='font-size:15px; color:black'> Error al crear nuevo Usuario</span>",
        "El Usuario ya existe..");
</script>
{% endif %}
<div>
    {% block header %}
    {% include 'partials/header.html' with {datos:datos} only %}
    {% endblock %}
    <h2 class="titulo-tabla">Usuarios Registrados </h2>
    <!-- Button to Open the Modal -->
    {% if "1" in datos.permisos %}
    <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#nuevoModal"><i
            class="fa fa-plus"></i> Crear Nuevo</button>
    <!-- The Modal -->
    <div class="modal fade" id="nuevoModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Alta de Usuario</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <form action="/usuarios/validarUsuario" method="post" id="formAlta">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="nombre" class="control-label">Nombre(nick):</label><span
                                    class="asterisco">*</span>
                                <input type="text" name="nombre" class="form-control" autofocus required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="dni" class="control-label">Persona Asociada:</label><span
                                    class="asterisco">*</span>
                                <select name="dni" class="form-control custom-select" required>
                                    <option value="" selected>Seleccione una Persona</option>
                                    {% for persona in datos.todosPersonas %}
                                    {% if persona.dni != '0' %}
                                    <option value={{ persona.dni }}>{{ persona.nombre }},&nbsp;{{ persona.apellido }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <label for="idRol" class="control-label">Seleccionar Rol:</label><span
                                    class="asterisco">*</span>
                                <select name="idRol" class="form-control custom-select" required>
                                    <option value="" selected>Seleccione un Rol</option>
                                    {% for rol in datos.roles %}
                                    <option value={{ rol.idRol }}>{{ rol.nombreRol }}</option>
                                    {% endfor %}}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="password" class="control-label">Contraseña:</label><span
                                    class="asterisco">*</span>
                                <input type="password" name="password" class="form-control" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="password" class="control-label">Confirme Contraseña:</label><span
                                    class="asterisco">*</span>
                                <input type="password" name="confirmPassword" class="form-control" required>
                            </div>
                        </div>
                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
                            <button type="submit" class="btn btn-success">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <table id="miTabla" class="table table-bordered table-sm table-responsive-lg table-striped table-hover text-nowrap">
        <thead class="headtable">
            <tr>
                <th>Nombre Usuario</th>
                <th>DNI </th>
                <th>Nombre y Apellido</th>
                <th>Rol</th>
                <th>Accion</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in datos.todosUsuarios %}
            <tr>
                <td>{{ usuario.nombre }}</td>
                <td><a href="#"
                        onclick="fichaPersona('{{ usuario.idPersona }}');return false;">{{ usuario.idPersona }}</a>
                </td>
                <td>{{ usuario.nombreApe }}</td>
                <td>{{ usuario.nombreRol }}</td>
                <td>
                    {% if "3" in datos.permisos %}
                    <!-- The Modal -->
                    <div class="modal fade" id="myModalModif{{ usuario.idPersona }}">
                        <div class="modal-dialog modal-xs">
                            <div class="modal-content">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Modificar Contraseña</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <form action="/usuarios/modificarUsuario" method="post"
                                        id="formModificar{{ usuario.idPersona }}">
                                        <input type="text" name="nombre" value="{{ usuario.nombre }}" hidden>
                                        <div class="form-group">
                                            <label for="password" class="control-label">Contraseña:</label><span
                                                class="asterisco">*</span>
                                            <input type="password" name="password" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="password" class="control-label">Confirme
                                                Contraseña:</label><span class="asterisco">*</span>
                                            <input type="password" name="confirmPassword" class="form-control" required>
                                        </div>
                                        <!-- Modal Footer -->
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-dismiss="modal">Salir</button>
                                            <button type="submit" class="btn btn-success">Enviar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                        data-target="#myModalModif{{ usuario.idPersona }}" title="Editar Usuario"><i
                            class="fa fa-pencil fa-2x fa-fw"></i>
                    </button>
                    <script>
                        $('#formModificar{{ usuario.idPersona }}').bootstrapValidator({
                            feedbackIcons: {
                                valid: 'fa fa-thumbs-up',
                                invalid: 'fa fa-remove',
                                validating: 'fa fa-refresh'
                            },
                            fields: {
                                password: {
                                    validators: {
                                        notEmpty: {
                                            message: 'Ingrese una Contraseña'
                                        }
                                    }
                                },
                                confirmPassword: {
                                    validators: {
                                        notEmpty: {
                                            message: 'Repita la Contraseña'
                                        },
                                        identical: {
                                            field: 'password',
                                            message: 'Las Contraseñas no coinciden'
                                        }
                                    }
                                },
                            }
                        });
                    </script>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <h2 class='error'>No hay Usuarios para mostrar</h2>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="/public/js/validarCampos.js"></script>
<script>
    var columnas = '0,1,2,3';
    var columNoOrdenar = 4;
    var titulo = 'Usuarios Registrados';
</script>
<script src="/public/js/ordypagtablas.js">
</script>
{% endblock %}