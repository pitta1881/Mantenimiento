{% extends "base.html" %}

{% block title %}Lista de Tareas{% endblock %}

{% block header %}
{% set nombreUsuario = datos.userLogueado %}
{% include 'partials/nav.html' with {nombreUsuario:nombreUsuario} only %}
{% endblock %}

{% block head %}
{{ parent() }}
<meta name="keywords" content="PAW,2018,Templates,PHP">
{% endblock %}

{% block main %}
<script>
    function mostrarFormulario() {
        var cambiarEstadoTarea = document.getElementById('cambiarEstadoTarea');
        if (cambiarEstadoTarea.style.display == "block") {
            cambiarEstadoTarea.style.display = "none";
        } else {
            cambiarEstadoTarea.style.display = "block"
        }
    }
</script>
<div class="general">

    <ul class="navTitulo">
        <img class="iconosTitulo" src="/public/res/back.svg" onclick="history.back()" title="Volver" title=" Volver">
        <h1>Su Tarea</h1>
        <img class="iconosTitulo" src="/public/res/print.svg" onclick="print()" title="Imprimir">
        {% if datos.miTarea.estado != "Finalizado" %}
        <a
            href="/tarea/modificar/seleccionado?idPedido={{ datos.miTarea.idPedido }}&idTarea={{ datos.miTarea.idTarea }}">
            <img class="iconosTitulo" src="/public/res/update.svg" title="Modificar">
        </a>
        {% if datos.miTarea.estado != 'Iniciado' %}
        {% set estados = ['En Curso','Pendiente','Finalizado'] %}
        <img class="iconosTitulo" src="/public/res/cambiarEstado.svg" onclick="mostrarFormulario()"
            title="Cambiar Estado">
        {% endif %}
        {% endif %}
        <a href="/tarea/verHistorial?idPedido={{ datos.miTarea.idPedido }}&idTarea={{ datos.miTarea.idTarea }}"><img
                class="iconosTitulo" src="/public/res/historyEstado.svg" title="Ver Historial"></a>

        <form action="/tarea/cambiarEstado/seleccionado" method="post" id="cambiarEstadoTarea" style="display: none">
            <input type="text" name="idPedido" value="{{ datos.miTarea.idPedido }}" hidden>
            <input type="text" name="idTarea" value="{{ datos.miTarea.idTarea }}" hidden>
            <input type="text" name="idOT" value="{{ datos.miTarea.miOT.idOT }}" hidden>
            <label for="estado" id="estadoLabel">Estado</label>
            <select name="estado" id="estadoSelect">
                {% for estado in estados %}
                {% if estado != datos.miTarea.estado %}
                <option value="{{ estado }}">{{ estado }}</option>
                {% endif %}
                {% endfor %}
            </select>
            <input type="button" value="Cambiar" id="cambiarEstadoSi" onclick="alertify.prompt( 'Cambiar Estado', 'Descripcion', ''
                , function(evt, value) { var descripcion = document.createElement('input'); descripcion.required = 'required'; descripcion.type = 'text'; descripcion.name = 'descripcion'; descripcion.value = value; document.getElementById('cambiarEstadoTarea').appendChild(descripcion); document.getElementById('cambiarEstadoTarea').submit(); }
                , function() {});">
        </form>

    </ul>

    <dl>
        <dt>Nº Pedido:</dt>
        <dd><a href="fichaPedido?id={{ datos.miTarea.idPedido }}">Pedido {{ datos.miTarea.idPedido }}</a></dd>
        <dt>Nº Tarea:</dt>
        <dd>{{ datos.miTarea.idTarea }}</dd>
        <dt>Especializacion:</dt>
        <dd>{{ datos.miTarea.especializacionNombre }}</dd>
        <dt>Descripcion:</dt>
        <dd>{{ datos.miTarea.descripcion }}</dd>
        <dt>Estado:</dt>
        <dd>{{ datos.miTarea.estado }}</dd>
        <dt>Prioridad:</dt>
        <dd>{{ datos.miTarea.prioridad }}</dd>
    </dl>
    <h2>PERTENECE A LA ORDEN DE TRABAJO:</h2>
    <table>
        <th>Nº OT</th>
        <th>Fecha de Inicio</th>
        <th>Fecha de Fin</th>
        <th>Estado</th>
        <th>Accion</th>
        {% if datos.miTarea.estado == "Iniciado" %}
        {% if datos.miTarea.agentes is empty %}
        <a href="#"><input type="button" value="Crear una OT"
                onclick="alertify.alert('Error','Primero debe asignar agentes')" ;></a>
        {% else %}
        <a href="/ot/crear"><input type="button" value="Crear una OT"></a>
        {% endif %}
        <h2 class='error'>No está asignado a ninguna OT</h2>
        {% else %}
        <tr>
            <td> <a href="/fichaOT?idOT={{ datos.miTarea.miOT.idOT }}" title="Ver Mas">OT
                    {{ datos.miTarea.miOT.idOT }}</a>
            </td>
            <td> {{ datos.miTarea.miOT.fechaInicio }} </td>
            <td> {{ datos.miTarea.miOT.fechaFin }} </td>
            <td> {{ datos.miTarea.miOT.estado }} </td>
            <td> <a href="/fichaOT?idOT={{ datos.miTarea.miOT.idOT }}" title="Ver Mas"> <img class="iconos"
                        src="/public/res/vermas.svg"></a></td>
        </tr>
        {% endif %}
    </table>
    <h2>AGENTES</h2>



    <form class="buscador" action="/pedido/buscar" method="POST">

        {% if  datos.miTarea.estado != "Finalizado" %}
        <a href="/tarea/agentes/asignar?idPedido={{ datos.miTarea.idPedido }}&idTarea={{ datos.miTarea.idTarea }}">
            <img class="crear" src="/public/res/add.svg">
        </a>
        {% endif %}
        <select name="filtro">
            <option value="id">Nº PEDIDO</option>
            <option value="sector">SECTOR</option>
            <option value="fechaInicio">FECHA INICIO</option>
            <option value="estado">ESTADO</option>
            <option value="prioridad">PRIORIDAD</option>
        </select>
        <input name="textBusqueda" type="Search" placeholder="Escribe parametro">
        <input type="submit" value="Buscar">
    </form>


    <table id="miTabla">
        <th onclick="sortTable(0,'miTabla')">Nº Agente</th>
        <th onclick="sortTable(1,'miTabla')">Nombre</th>
        <th onclick="sortTable(2,'miTabla')">Apellido</th>
        <th onclick="sortTable(3,'miTabla')">Especializacion</th>
        <th onclick="sortTable(4,'miTabla')">Accion</th>
        {% for agente in datos.miTarea.agentes %}
        <tr>
            <td><a href="/fichaPersona?idAgente={{ agente.idAgente }}">{{ agente.idAgente }}</a></td>
            <td>{{ agente.nombre }}</td>
            <td>{{ agente.apellido }}</td>
            <td>{{ agente.especializacionNombre }}</td>
            <td>
                <a href="/fichaPersona?idAgente={{ agente.idAgente }}">
                    <img class="iconos" src="/public/res/vermas.svg" title="Ver Mas" title="Ver Mas">
                </a>
                {% if  datos.miTarea.estado != "Finalizado" %}
                <form action="/tarea/agentes/desasignar" method="post" hidden
                    id="formDesasignar{{ datos.miTarea.idPedido }}_{{ datos.miTarea.idTarea }}_{{ agente.idAgente }}">
                    <input type="text" name="idPedido" value="{{ datos.miTarea.idPedido }}" hidden>
                    <input type="text" name="idTarea" value="{{ datos.miTarea.idTarea }}" hidden>
                    <input type="text" name="idAgente" value="{{ agente.idAgente }}" hidden>
                </form>
                <img class="iconos" src="/public/res/remAgente.svg" title="Desasignar Agente"
                    onclick="alertify.confirm('Desasignar Agente','¿Esta seguro?',function(){document.getElementById('formDesasignar{{ datos.miTarea.idPedido }}_{{ datos.miTarea.idTarea }}_{{ agente.idAgente }}').submit()},function(){})">
                {% endif %}
            </td>
        </tr>
        {% else %}
        <h2 class='error'>No hay Agentes asignados aún</h2>
        {% endfor %}
    </table>
</div>
{% endblock %}